<html>

<head>
<title>HTML5 Canvas &mdash; Demo polygon</title>
<meta http-equiv="content-type" content="text/html; charset=UTF8">

<style>
    canvas {border: solid 1px black}
    td {vertical-align: top;}
    #msgBox {color:gray;}
    h1, h2, h3, h4 {margin-top: 5px; margin-bottom: 5px;}
    .button {
      border: none;
      display: inline-block;
      font-size: 16px;
      margin: 10px , 10px;
      cursor: pointer;
      -webkit-transition-duration: 0.4s; /* Safari */
      transition-duration: 0.4s;
      width: 100;
      height: 50;
    }
    .color {
            padding: 32px 32px;
    }
    .tool {
            text-align: center;
            text-decoration: none;
            background-color: #C0C0C0;
    }
    .tool:hover { background-color: #A0A0A0;}

    .b1 {background-color: #FF0000;} /* Red */
    .b2 {background-color: #00FF00;} /* Green */
    .b3 {background-color: #0000FF;} /* Blue */
    .b4 {background-color: #000000;} /* Black */

    .b4:hover { background-color: #808080;}
    .b1:hover { background-color: #FFA0A0;}
    .b2:hover { background-color: #A0FFA0;}
    .b3:hover { background-color: #A0A0FF;}


</style>
</head>

<script type="text/javascript">
    // Keep canvas, ctx and model as global variables
    // Dirty, but practical for this small scale demo
    // A real production system would need to define a scope to protect them
    var canvas;
    var ctx;

    /* ### Model ### */

    var model
    function initModel() {
        model = {
                linecolor : 'red' ,
                fillcolor : 'white',
                x : [] ,
                y : [] ,
                state : 0,
                selectorColor:"gray" ,
                selected : -1,
                selectedColor:"black"
        }
        model.x.push(Math.floor(Math.random() * 400))
        model.y.push(Math.floor(Math.random() * 400))
        model.x.push(Math.floor(Math.random() * 400))
        model.y.push(Math.floor(Math.random() * 400))
        model.x.push(Math.floor(Math.random() * 400))
        model.y.push(Math.floor(Math.random() * 400))
    }

    /* ### Mouse ### */

    function initMouse(canvas) {
        canvas.addEventListener("mousedown", onMouseDown, false);
        canvas.addEventListener("mouseup",   onMouseUp, false);
        canvas.addEventListener("mousemove", onMouseMove, false);
    }
    // Auxiliary function to convert from client to canvas coordinates
    // Note: very simple; will break if canvas is not top level element
    Math.dist=function(x1,y1,x2,y2){
        if(!x2) x2=0;
        if(!y2) y2=0;
        return Math.sqrt((x2-x1)*(x2-x1)+(y2-y1)*(y2-y1));
    }
    function getMousePos(canvas, event) {
        var rect = canvas.getBoundingClientRect();
        return {
          x: Math.round(event.clientX - rect.left),
          y: Math.round(event.clientY - rect.top)
        };
    }
    function onMouseDown(event) {
        //console.log("onMouseDown: event = ",event);
        var pos = getMousePos(canvas, event);

        document.getElementById('msgBox').innerHTML ="mouseDown (x="+pos.x+",y="+pos.y+")";
        if (model.state == 0){
            model.x.push(pos.x)
            model.y.push(pos.y)
        } else if(model.state == 2){
            canvas.addEventListener("mousemove", onMouseMoveMoveNode, false);

        } else if(model.state == 3){
            selectNearestNode(pos.x,pos.y)
        }
        console.log(model.selected);

        draw()
        //ctx.rect(pos.x-5,pos.y-5, 10,10);
        //ctx.stroke()
    }
    function onMouseUp(event) {
        //console.log("onMouseUp: event = ",event);
        var pos = getMousePos(canvas, event);

        document.getElementById('msgBox').innerHTML =
           "mouseUp (x="+pos.x+",y="+pos.y+")";
        if (model.state == 2){
            canvas.removeEventListener("mousemove", onMouseMoveMoveNode, false);
        }
    }
    function onMouseMove(event) {
        //console.log("onMouseMove: event = ",event);
        var pos = getMousePos(canvas, event);

        document.getElementById('msgBox').innerHTML = "mouseMove (x="+pos.x+",y="+pos.y+")"+model.selected;
    }
    function onMouseMoveMoveNode(event){
        var pos = getMousePos(canvas, event);
        if (model.state==2){
            model.x[model.selected] = pos.x
            model.y[model.selected] = pos.y
            draw()
        }
    }
    function colorFunction(color) {
      model.linecolor = color
      draw()
    }
    function toolFunction(tool) {
      if (tool == "new"){
        model.state = 0
      } else if (tool == "remove"){
          if (model.selected > -1){
              model.x.splice(model.selected,1)
              model.y.splice(model.selected,1)
          }
          model.selected = -1
          draw()
      } else if (tool == "edit"){
        model.state = 2
      }else if (tool == "select"){
        model.state = 3
      }
    }    /* ### Keyboard ### */
    function selectNearestNode(x , y){
        min = 10
        dist = min
        selected = -1

        for(i = 0; i < model.x.length; i++){
            tmp = Math.dist(x , y , model.x[i] , model.y[i])
            if (tmp < dist){
                dist = tmp
                selected = i
            }
        }
        if (dist <= min){
            model.selected = selected
        }
    }
    function initKeys() {
        // Approach 1: handle keyDown in the canvas
        //canvas.setAttribute('tabindex','0');
        //canvas.focus();
        //canvas.addEventListener( "keydown", onKeyDown, true);

        // Approach 2: handle it at document level
        document.addEventListener( "keydown", onKeyDown, true);
    }
    function onKeyDown(event) {
        //console.log('onMouseUp: event=',event)
        document.getElementById('msgBox').innerHTML =
              "keyDown (key='"+event.key+"',keyCode="+event.keyCode+")";
    }

    /* ### Drawing ### */

    function draw() {
        ctx.clearRect(0,0,canvas.width,canvas.height)

        ctx.strokeStyle = model.linecolor
        ctx.fillStyle = model.fillcolor
        ctx.lineWidth = 3;
        ctx.beginPath()
        ctx.moveTo(model.x[0] , model.y[0])
        for(i = 1; i < model.x.length; i++){
                ctx.lineTo(model.x[i] , model.y[i])
        }
        ctx.closePath()
        ctx.stroke()
        ctx.fill()

        ctx.lineWidth = 1;
        for(i = 0; i < model.x.length; i++){
            ctx.beginPath()
            if (i==model.selected){
                ctx.strokeStyle = model.selectedColor
            } else {
                ctx.strokeStyle = model.selectorColor
            }
            ctx.rect(model.x[i]-5,model.y[i]-5, 10,10);
            ctx.stroke()
            ctx.closePath()
        }
        /*
        ctx.beginPath()
        ctx.rect(model.x[selected]-5,model.y[selected]-5, 10,10);
        ctx.stroke()
        ctx.closePath()
        */

    }

    /* ### Initialization ### */

    function onLoad() {
        canvas = document.getElementById('myCanvas');
        ctx = canvas.getContext('2d');

        // Do init
        initModel()
        initKeys()
        initMouse(canvas)

        // Draw stuff
        draw()
    }
</script>

<body onload="onLoad();">
    <h2>Polygon demo - <i>Angel A. Sanquiche Sanchez</i></h2>

    <h4>Canvas</h4>
    <canvas id="myCanvas" width="400" height="400"></canvas>
    <div>
      <button onclick="colorFunction('red')" class="button color b1"></button>
      <button onclick="colorFunction('green')" class="button color b2"></button>
      <button onclick="colorFunction('blue')" class="button color b3"></button>
      <button onclick="colorFunction('black')" class="button color b4"></button>
    </div>
    <div>
      <button onclick="toolFunction('new')" class="button tool New">New</button>
      <button onclick="toolFunction('remove')" class="button tool Remove">Remove</button>
      <button onclick="toolFunction('edit')" class="button tool Edit">Edit</button>
      <button onclick="toolFunction('select')" class="button tool Select">Select</button>
    </div>
    <p><small>Message: <span id="msgBox"></span></small></p>

    <h4>Description</h4>
    <i>In this page the user can use tools to make a polygon</i><br>
    At loading: Draws a triangle.<br>
    Mouse click: Draws a small rectangle at mouse position.<br>
    Key Press: Prints the key in the message box

</body>
</html>
